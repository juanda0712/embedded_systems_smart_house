{% extends "layout.html" %}

{% block title %}Casa Inteligente{% endblock %}

{% block content %}

<div class="contenedor">
    <div class="columna-izquierda">
        <h1>Casa Inteligente</h1>
        <div id="casa">
            <svg id="plano-casa" width="800" height="500" xmlns="http://www.w3.org/2000/svg">
        
                <!-- Pasillo de Entrada -->
                <rect x="350" y="25" width="100" height="55" fill="#b5e7a0" stroke="#333" stroke-width="3" />
                <text x="400" y="50" text-anchor="middle" font-size="14" fill="#000">Entrada</text>
        
                <!-- Habitación 1 -->
                <rect id="habitacion-1" x="200" y="80" width="180" height="150" fill="#ddd" stroke="#333" stroke-width="3"/>
                <text x="290" y="160" text-anchor="middle" font-size="16" fill="#000">Habitación 1</text>
        
                <!-- Habitación 2 -->
                <rect id="habitacion-2" x="420" y="80" width="180" height="150" fill="#ddd" stroke="#333" stroke-width="3"/>
                <text x="510" y="160" text-anchor="middle" font-size="16" fill="#000">Habitación 2</text>
        
                <!-- Sala -->
                <rect id="habitacion-3" x="200" y="230" width="180" height="150" fill="#ddd" stroke="#333" stroke-width="3"/>
                <text x="290" y="300" text-anchor="middle" font-size="16" fill="#000">Sala</text>
        
                <!-- Cocina -->
                <rect id="habitacion-4" x="420" y="230" width="90" height="150" fill="#ddd" stroke="#333" stroke-width="3"/>
                <text x="465" y="300" text-anchor="middle" font-size="16" fill="#000">Cocina</text>
        
                <!-- Comedor -->
                <rect id="habitacion-5" x="510" y="230" width="90" height="150" fill="#ddd" stroke="#333" stroke-width="3"/>
                <text x="555" y="300" text-anchor="middle" font-size="16" fill="#000">Comedor</text>
        
                <!-- Patio / Jardín -->
                <rect id="patio" x="200" y="380" width="400" height="100" fill="#b5e7a0" stroke="#333" stroke-width="3"/>
                <text x="400" y="430" text-anchor="middle" font-size="16" fill="#000">Patio / Jardín</text>
        
                <!-- Puertas (todas iguales y con IDs) -->
                <!-- Puerta entrada -->
                <rect id="puerta-3" x="375" y="75" width="50" height="10" fill="#8b4513" stroke="#000" stroke-width="2"/>
                
                <!-- Puerta trasera -->
                <rect id="puerta-1" x="375" y="375" width="50" height="10" fill="#8b4513" stroke="#000" stroke-width="2"/>
        		
                <!-- Puerta Habitación 1 -->
                <rect id="puerta-4" x="375" y="130" width="10" height="50" fill="#8b4513" stroke="#000" stroke-width="2"/>
                
                <!-- Puerta Habitacion 2 -->
                <rect id="puerta-2" x="415" y="130" width="10" height="50" fill="#8b4513" stroke="#000" stroke-width="2"/>        
        
            </svg>
        </div>
    </div>

    <div class="columna-derecha">
        <!-- Control de luces -->
        <div id="controles-luces">
            <h2>Control de luces</h2>
        </div>

        <!-- Estado de puertas -->
        <div id="puertas">
            <h2>Estado de puertas</h2>
        </div>

        <!-- Jardín -->
        <div id="jardin">
            <h2>Jardín</h2>
            <button onclick="verJardin()">Tomar foto del jardín</button>
            <div id="foto-jardin"></div>
        </div>
    </div>
</div>

<script>
    async function obtenerLuces() {
        const res = await fetch('/api/luces');
        return await res.json();
    }

    async function actualizarLuces(nuevoEstado) {
        await fetch('/api/luces', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ luces: nuevoEstado })
        });
    }

    async function cambiarLuz(index) {
        const luces = await obtenerLuces();
        luces[index] = !luces[index];
        await actualizarLuces(luces);
        renderLuces();
        actualizarCasa();
    }

    async function renderLuces() {
        const luces = await obtenerLuces();
        const cont = document.getElementById('controles-luces');
        cont.innerHTML = '<h2>Control de luces</h2>';

        luces.forEach((estado, i) => {
            const btn = document.createElement('button');
            btn.textContent = `Luz ${i + 1}: ${estado ? 'Encendida' : 'Apagada'}`;
            btn.onclick = () => cambiarLuz(i);
            cont.appendChild(btn);
        });
    }

    async function renderPuertas() {
        const res = await fetch('/api/puertas');
        const puertas = await res.json();
        const cont = document.getElementById('puertas');
        cont.innerHTML = '<h2>Estado de puertas</h2>';

        puertas.forEach((estado, i) => {
            const p = document.createElement('p');
            p.textContent = `Puerta ${i + 1}: ${estado ? 'Abierta' : 'Cerrada'}`;
            cont.appendChild(p);

            const puerta = document.getElementById(`puerta-${i + 1}`);
            if (puerta) {
                puerta.setAttribute('fill', estado ? '#32CD32' : '#8b4513'); // Verde si abierta, marrón si cerrada
            }
        });
    }

    async function actualizarCasa() {
        const luces = await obtenerLuces();
        for (let i = 0; i < luces.length; i++) {
            const hab = document.getElementById(`habitacion-${i + 1}`);
            if (hab) {
                hab.setAttribute('fill', luces[i] ? '#ffff66' : '#ddd');
            }
        }
    }

    function verJardin() {
        const cont = document.getElementById('foto-jardin');
        const img = document.createElement('img');
        img.src = '/api/camara?' + new Date().getTime(); // evitar caché
        img.alt = "Foto del jardín";
        img.style.maxWidth = '100%';
        cont.innerHTML = '';
        cont.appendChild(img);
    }

    function init() {
        renderLuces();
        renderPuertas();
        actualizarCasa();

        setInterval(renderPuertas, 50);
        setInterval(actualizarCasa, 50);
    }

    window.onload = init;
</script>

<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f9f9f9;
        margin: 0;
        padding: 0;
    }

    .contenedor {
        display: flex;
        padding: 20px;
        gap: 30px;
    }

    .columna-izquierda, .columna-derecha {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }

    .columna-izquierda {
        flex: 3;
    }

    .columna-derecha {
        flex: 2;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    h1, h2 {
        color: #333;
    }

    button {
        margin: 5px 0;
        padding: 10px 15px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    button:hover {
        background-color: #45a049;
    }

    #foto-jardin img {
        margin-top: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
</style>
{% endblock %}
